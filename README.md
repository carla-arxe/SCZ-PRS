# SCZ_PRS_analysis

This repository contains the code used for the project:  
**Study of Antagonistic Pleiotropy as a Mechanism for the Maintenance of Schizophrenia Genetic Risk Variants through Evolution**

## Reference

Carla Arxé Asensio  
June 18, 2025

---

## Overview

This repository contains the code and data processing pipelines used to compute polygenic risk scores (PRS) for schizophrenia (SCZ), using data from the UK Biobank. The main focus of the project is to study the evolutionary maintenance of SCZ risk variants, potentially under antagonistic pleiotropy.

## Repository Structure

The repository is structured into several folders, each containing scripts and resources for specific stages of the analysis. Below, we describe the content of each folder.

The repository is organized into the following directories:

- `PCA/`: scripts for initial participant filtering and PCA computation
- `PRS/`: scripts and tools for PRS computation using imputed genotyping data
- `PRS_NT/` *(not yet documented here)*
- `ICD-10/` *(analysis folder, not yet documented here)*

---

## `PCA` – Principal Component Analysis Preparation

This folder contains scripts to perform participant filtering and principal component analysis (PCA), necessary for population stratification correction in downstream PRS analyses.

These scripts are located at:

users/genomics/arxe/SCZ/PCA

### Scripts

- **`0.filter_participants.sh`**  
  Filters out individuals who withdrew consent.

- **`0.filter_participants_v2.sh`**  
  Filters participants based on European ancestry using the UK Biobank field 22006, with the `euro_keep.txt` list; also applies the consent filter.

- **`1.filter_compare.sh`**  
  Compares the results of filtering from the scripts above, verifying consistency.

- **`2.pruning_pca.sh`**  
  Performs SNP pruning using PLINK on the unfiltered and unimputed BED files — considered the *old* version.

- **`2.pruning_pca_v2.sh`**  
  Updated version of the pruning script using the sample filtered to Europeans (`0.filter_participants_v2.sh` output).

- **`2.pruningcompare.sh`**  
  Compares pruning outputs from both versions and the individuals used for the pca generated by (Eva).

- **`3.pca.sh`**  
  Calculates principal components (PCs) using PLINK on the unfiltered dataset — *old* version.

- **`3.pca_v2.sh`**  
  Updated version of PCA calculation using the filtered European sample.

### Additional Files

This folder also contains:

- **Input files**: such as raw BED/BIM/FAM files from UK Biobank, population reference lists (`euro_keep.txt`), and field-specific filter lists.
- **Output files**: resulting PC scores, pruned datasets, logs.
- **Slurm job files**: used to submit jobs to HPC clusters for each step.
  
### Notes

- Input and output files, as well as SLURM submission scripts, are also stored here.
- PCA outputs (`*.eigenvec`, `*.eigenval`) are used in PRS correction downstream.

## `PRS/` – Polygenic Risk Score Calculation

This folder contains all scripts, SLURM jobs, inputs, and tool dependencies to compute PRS for schizophrenia across UK Biobank participants, using imputed genotype data.

### Main Script

- **`04_PRS_DATA_PIPELINE_PRC_v4.sh`**

This is the main pipeline, originally developed by Pol and updated for this project. It includes:

1. Sample filtering and data harmonization
2. PRS calculation using [`PRSice`](https://www.prsice.info/) across a grid of clumping LD thresholds and GWAS p-value thresholds
3. Aggregation of scores and generation of quantile/decile groupings
4. Correction for principal components and covariates
5. Output organization into dedicated folders

All parameter definitions (paths, thresholds, SNP filters) are defined within the script.

### Required Files

The pipeline expects the following files in the working directory:

- Genotype files: `POSTIMPtargetdata.bed`, `.bim`, `.fam`
- Summary statistics: `Basedata_*.txt` (e.g., `2B_Basedata_PGC_SCZ_european.txt`)
(- SNP lists: `SNPlist_*.txt`) --> For PRS_NT
- Target Sample information: `Target_data_*.txt` (includes FID/IID, phenotype, sex)
- Covariate and phenotype R scripts:
  - `PRS1_FID_IID.R`
  - `PRS1_Target_data_phenotype.R`
  - `PRS1_Covariances.R`
- PRS generation and analysis scripts:
  - `PRS3_PRS_all.R`
  - `PRS3_PRS-PCA.R`
  - `PRS3_Models.Rmd`
  - `PRS3_Deciles.R`
- PCA results from preprocessing:
  - *.eigenvec

These scripts are automatically invoked during pipeline execution.

### Output

After running, PRS results are stored in:

PRS/3_PRSice_originalBasedata/

This includes:
- PRS scores per individual (`PRS_individuals_all.txt`)
- Quantile-stratified results (`PRS_individuals_deciles.txt`)
- Summary reports (`.html`, `.pdf`)
- Outputs organized by clumping/p-value combinations:  
  `3_ClLD{R2}_PT{pval}/...`

**Note:** Multiple versions of `3_PRSice_originalBasedata/` may exist due to reruns. (Confirm which version is the correct one for analysis).

### SLURM Jobs

All SLURM submission scripts used to launch the pipeline on HPC are available. These scripts submit `04_PRS_DATA_PIPELINE_PRC_v4.sh` and handle module loading and resource requests.

### PRSice Tool

The pipeline uses the [PRSice](https://www.prsice.info/) software to compute polygenic risk scores. Its two main components are stored in different locations:

- `PRSice.R`: Located at /users/genomics/arxe/SCZ/PRSice_linux/PRSice.RThis file is invoked from within the main pipeline script.
- `PRSice` (Linux compiled binary):Located inside the repository at PRS/PRSice_linux/PRSice

Ensure correct permissions and module dependencies are set in your cluster environment to run this tool.

---

## `PRS_NT/` – Polygenic Risk Score Calculation for each Neurotransmitter

This folder contains a pipeline to compute PRS for schizophrenia, stratified by gene sets related to specific neurotransmitter systems. The goal is to explore whether SCZ risk is enriched in functionally grouped pathways.

### Main Script

- **`04_PRS_DATA_PIPELINE_PRC_v4.sh`**

This is the main script for the PRS_NT/ pipeline. It has the same structure as the classical PRS pipeline in the PRS/ directory, with the key difference being the stratification by neurotransmitter-related gene sets.

The script:
  - Iterates over combinations of neurotransmitters and SNP list types
  - Executes PRSice with appropriate SNP filters and p-value thresholds
  - Organizes outputs by neurotransmitter
  - Moves intermediate files to _FilesCreated/ for clarity

Analyzed Neurotransmitters:
  - DA: Dopamine
  - GABA
  - Glu: Glutamate
  - HT: Serotonin
  - NT: Combination of all above
SNP List Types:
  - ext: Extensive – Genes annotated in at least one source
  - com: Common – Genes supported by at least two annotation sources

SNP list filenames follow the format:
  - SNPlist_ext_DA.txt
  - SNPlist_com_GABA.txt
  - ...

### Required Files

The pipeline expects the following files in the working directory:

- Genotype files: `POSTIMPtargetdata.bed`, `.bim`, `.fam`
- Summary statistics: `Basedata_*.txt` (e.g., `2B_Basedata_PGC_SCZ_european.txt`)
- SNP lists (specific to this pipeline):
  - SNPlist_*.txt
- Target Sample information: `Target_data_*.txt` (includes FID/IID, phenotype, sex)
- Covariate and phenotype R scripts:
  - `PRS1_FID_IID.R`
  - `PRS1_Target_data_phenotype.R`
  - `PRS1_Covariances.R`
- PRS generation and analysis scripts:
  - `PRS3_PRS_all.R`
  - `PRS3_PRS-PCA.R`
  - `PRS3_Models.Rmd`
  - `PRS3_Deciles.R`
- PCA results from preprocessing:
  - *.eigenvec

These scripts are automatically invoked during pipeline execution.

### Output

For each neurotransmitter and list-type combination, the pipeline creates a separate results folder (e.g., DA_ext/, HT_com/, etc.), containing:
  - PRS_individuals_deciles.txt
  - Model summaries (.html, .pdf, etc.)
  - PRS results across multiple p-value thresholds and LD settings

All intermediate and log files are automatically cleaned and moved to _FilesCreated/.

### SLURM Jobs

All SLURM submission scripts used to launch the pipeline on HPC are available. These scripts submit `04_PRS_DATA_PIPELINE_PRC_v4.sh` and handle module loading and resource requests.

---

## `ICD-10/` – PRS Analysis and ICD-10 Diagnoses

This folder contains analyses linking schizophrenia PRS with other medical diagnoses coded under the ICD-10 classification. The main objective is to detect patterns of **antagonistic pleiotropy** or other significant correlations between genetic predisposition to schizophrenia and various health conditions.

Both previously generated PRS results and individual-level diagnostic data are used. The folder includes R and Bash scripts, tabular and graphical results, as well as PDFs generated from the models.

### Main Scripts

> ⚠️ Some scripts are still under local development, and the final versions have not yet been uploaded.

- **`sz_prs_icd10_analysis_v2.R` and `.sh`**  
Main script for identifying ICD-10 diagnoses significantly associated with schizophrenia PRS. It filters and transforms data, creates binary diagnosis matrices, and runs logistic models for each ICD-10 code. Includes:
  - Diagnosis transformation to long format (`pivot_longer`)
  - Creation of a binary matrix by 3-character ICD-10 code
  - Merging with residualized PRS
  - Logistic modeling (binomial GLM) per ICD-10 code
  - FDR correction of p-values
  - Export of results (`results_with_F.csv`, `results_no_F.csv`)

- **`prev_long.R`**  
  Script to pivot diagnosis data into long format and calculate prevalence by PRS quantile. Exports a `.txt` file with these results.

- **`models_pdf.R` and `.sh`**  
  Script that fits different models to code-wise prevalence data (linear, logarithmic, power), computes metrics (AIC, R², RSS), and generates:
  - Summary of models per code
  - Residual plots
  - Calculation and visualization of Odds Ratios across PRS quantiles
  - Export to `.pdf` files per code

- **`analysis_lvl2.R` and `.sh`**  
  Currently under development. The aim is to perform higher-resolution analyses (ICD-10 sublevels) or multivariate models including covariates.

### File Structure

#### Required Data

- `3_PRS_PC1_res.txt`: Residualized PRS results  
- `ukb668761_41270_wb.txt`: UK Biobank ICD-10 diagnoses  

#### Results

- `results_with_F.csv`, `results_no_F.csv`: Results of the analysis including and excluding ICD-10 Chapter F (mental disorders)  
- `prevalence_by_quantile.txt`: Prevalence by ICD-10 code and PRS quantile  
- PDFs from `models_pdf.R`: Fitted models and OR visualizations by PRS quantile

#### SLURM Jobs

All `.sh` scripts have corresponding SLURM submission files with module loading, resource specifications, and logging options.


## To Do

- [ ] Validate which version of `3_PRSice_originalBasedata/` to use
- [ ] Data

---

## Data Access

All data originate from **UK Biobank**. Due to usage restrictions:

- Raw genotype and phenotype files are **not** included here.
- Refer to the [UK Biobank Data Showcase](https://biobank.ctsu.ox.ac.uk/crystal/) and your institutional permissions.
